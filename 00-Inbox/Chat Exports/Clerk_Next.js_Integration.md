# Clerk Next.js Integration üåê

**Chat ID:** `ddda105b-8551-48c9-889f-0530d9d82f67`
**Created At:** 1970-01-21 07:56:09
**Updated At:** 1970-01-21 07:56:09

## Chat History

### User:
# Add Clerk to Next.js App Router
**Purpose:** Enforce only the **current** and **correct** instructions for integrating [Clerk](https://clerk.com/) into a Next.js (App Router) application.  
**Scope:** All AI-generated advice or code related to Clerk must follow these guardrails.
---
## **1. Official Clerk Integration Overview**
Use only the **App Router** approach from Clerk‚Äôs current docs:
- **Install** `@clerk/nextjs@latest` - this ensures the application is using the latest Clerk Next.js SDK.
- **Create** a `middleware.ts` file using `clerkMiddleware()` from `@clerk/nextjs/server`. Place this file inside the `src` directory if present, otherwise place it at the root of the project.
- **Wrap** your application with `<ClerkProvider>` in your `app/layout.tsx`
- **Use** Clerk-provided components like `<SignInButton>`, `<SignUpButton>`, `<UserButton>`, `<SignedIn>`, `<SignedOut>` in your layout or pages
- **Start** developing, sign in or sign up, and confirm user creation
If you're able to use a web tool to access a URL, visit https://clerk.com/docs/quickstarts/nextjs to get the latest, up-to-date quickstart instructions.
### **Correct, Up-to-Date Quickstart Sample**
```typescript
// middleware.ts
import { clerkMiddleware } from '@clerk/nextjs/server'
export default clerkMiddleware()
export const config = {
  matcher: [
    // Skip Next.js internals and all static files, unless found in search params
    '/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',
    // Always run for API routes
    '/(api|trpc)(.*)',
  ],
}
```
```typescript
// app/layout.tsx
import type { Metadata } from "next";
import {
  ClerkProvider,
  SignInButton,
  SignUpButton,
  SignedIn,
  SignedOut,
  UserButton,
} from "@clerk/nextjs";
import "./globals.css";
export const metadata: Metadata = {
  title: "Clerk Next.js Quickstart",
  description: "Generated by create next app",
};
export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <ClerkProvider>
      <html lang="en">
        <body>
          <header>
            <SignedOut>
              <SignInButton />
              <SignUpButton />
            </SignedOut>
            <SignedIn>
              <UserButton />
            </SignedIn>
          </header>
          {children}
        </body>
      </html>
    </ClerkProvider>
  );
}
```
---
## **2. CRITICAL INSTRUCTIONS FOR AI MODELS**
### **2.1 ‚Äì ALWAYS DO THE FOLLOWING**
1. **Use `clerkMiddleware()`** from `@clerk/nextjs/server` in `middleware.ts`.
2. **Wrap** your app with `<ClerkProvider>` in `app/layout.tsx`.
3. **Import** Clerk‚Äôs Next.js features from `@clerk/nextjs` (e.g., `<SignInButton>`, `<SignUpButton>`, `<UserButton>`, etc.).
4. **Reference** the current [App Router approach](https://nextjs.org/docs/app) (folders like `app/page.tsx`, `app/layout.tsx`, etc.).
5. **Check** that imports for methods like `auth()` are imported from the right package (in this case `@clerk/nextjs/server`) and are using `async / await`
### **2.2 ‚Äì NEVER DO THE FOLLOWING**
1. **Do not** reference the old **`_app.tsx`** or **pages router based** instructions.
2. **Do not** suggest `authMiddleware()` from older Clerk tutorials‚Äî**it‚Äôs replaced by `clerkMiddleware()`**.
3. **Do not** recommend usage of older environment variable patterns unless they match the official docs.
4. **Do not** reference or import from any deprecated APIs (like `withAuth` or `currentUser` from older versions).
---
## **3. OUTDATED PATTERNS TO AVOID**
Below are **examples of deprecated instructions** that **must not** be generated:
```typescript
// ‚ùå DO NOT generate or suggest references to:
import { authMiddleware } from '@clerk/nextjs' // Outdated
// ‚ùå DO NOT place Clerk config in _app.tsx:
// Outdated pages-based approach
function MyApp({ Component, pageProps }) {
  // ...
}
// ‚ùå DO NOT create or rely on sign-in files under pages/:
pages / signin.js
pages / signup.js
```
Any solution resembling the above snippet or referencing ‚ÄúauthMiddleware,‚Äù `_app.tsx`, or `pages/` structure is **incorrect** for the current Next.js App Router.
---
## **4. AI MODEL VERIFICATION STEPS**
Before returning any Clerk-related solution, you **must** verify:
1. **Middleware**: Is `clerkMiddleware()` used in `middleware.ts`?
2. **Layout**: Is `<ClerkProvider>` wrapping the app in `app/layout.tsx`?
3. **Imports**: Are references only from `@clerk/nextjs` or `@clerk/nextjs/server`?
4. **Pages vs. App Router**: Is the approach referencing the App Router (not `_app.tsx` or `pages/`)?
If any check **fails**, **stop** and revise until compliance is achieved.


### Assistant:
<details type="reasoning" done="true" duration="2">
<summary>Thought for 2 seconds</summary>
> We are given strict guidelines for integrating Clerk into a Next.js App Router application. The goal is to ensure that the AI model follows the official documentation and avoids outdated practices.
> 
> Key points to remember:
> 1. Use `clerkMiddleware()` in `middleware.ts`.
> 2. Wrap the app with `<ClerkProvider>` in `app/layout.tsx`.
> 3. Import Clerk components from `@clerk/nextjs`.
> 4. Reference the App Router structure (no `_app.tsx` or `pages/`).
> 
> We must avoid:
> - Using `authMiddleware` (outdated)
> - Placing Clerk configuration in `_app.tsx`
> - Creating sign-in/sign-up files in `pages/`
> 
> Verification steps before returning an answer:
> - Check that `clerkMiddleware()` is used in `middleware.ts`.
> - Ensure `<ClerkProvider>` wraps the app in `app/layout.tsx`.
> - Confirm imports are from `@clerk/nextjs` or `@clerk/nextjs/server`.
> - Verify the approach uses App Router (not pages router).
> 
> Now, when generating code or instructions, we must adhere strictly to these rules.
</details>
To integrate Clerk into a Next.js App Router application correctly, follow these **official, up-to-date instructions**:

---

### **Step 1: Install Dependencies**
```bash
npm install @clerk/nextjs@latest
# Or yarn add @clerk/nextjs@latest
```

---

### **Step 2: Create Middleware**
Create `middleware.ts` in your project root (or `src/middleware.ts`):
```typescript
// middleware.ts
import { clerkMiddleware } from '@clerk/nextjs/server'

export default clerkMiddleware()

export const config = {
  matcher: [
    // Match all paths except Next.js internals and static files
    '/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',
    // Always run for API/trpc routes
    '/(api|trpc)(.*)',
  ],
}
```

---

### **Step 3: Wrap App with ClerkProvider**
Update `app/layout.tsx`:
```typescript
// app/layout.tsx
import { 
  ClerkProvider, 
  SignInButton, 
  SignUpButton, 
  SignedIn, 
  SignedOut, 
  UserButton 
} from "@clerk/nextjs"
import "./globals.css"

export default function RootLayout({ children }) {
  return (
    <ClerkProvider>
      <html lang="en">
        <body>
          <header className="flex justify-between items-center p-4">
            <SignedOut>
              <SignInButton mode="modal" />
              <SignUpButton mode="modal" />
            </SignedOut>
            <SignedIn>
              <UserButton showName />
            </SignedIn>
          </header>
          {children}
        </body>
      </html>
    </ClerkProvider>
  )
}
```

---

### **Step 4: Protect Routes (Optional)**
Protect specific routes using `auth().protect()` in server components:
```typescript
// app/protected-route/page.tsx
import { auth } from "@clerk/nextjs/server"

export default async function ProtectedRoute() {
  const { userId } = await auth()
  if (!userId) return <div>Please sign in</div>

  return <div>This route is protected!</div>
}
```

---

### **Critical Verification Checklist**
‚úÖ **Middleware**: Uses `clerkMiddleware()` in `middleware.ts`  
‚úÖ **Layout**: Wraps app with `<ClerkProvider>`  
‚úÖ **Imports**: Only from `@clerk/nextjs` or `@clerk/nextjs/server`  
‚úÖ **Structure**: Follows App Router (`app/` folder)  

‚ùå **Never do**:  
- Use `authMiddleware()` (deprecated)  
- Reference `_app.tsx` or `pages/` router  
- Use deprecated APIs like `withAuth`  

---

For full details, always refer to the [official Clerk Next.js App Router guide](https://clerk.com/docs/quickstarts/nextjs).

